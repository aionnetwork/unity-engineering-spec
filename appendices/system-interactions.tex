\section{System Interactions}

This appendix illustrates major user and cross-contract interactions, for didactic purposes. Note, that anything in curly brackets (\{\}) after function calls indicates the coin amount enclosed in the transaction (function call).

\label{appendix:sequence_diagrams}

\subsection{Private Staking}
Figure \ref{fig:priv_staking} describes the scenario where a Staker chooses to privately bond their coins as stake (i.e. run their own node), and then after some time, unbond those coins. The staker must first register with the StakerRegistry contract. Then the staker must send a \say{vote} message (to their own address in the StakerRegistry), sending the amount to bond as the transaction amount. 

When the staker is ready to unbond the stake, the staker must do so across two transactions. First, the staker must send the unvote (with the amount to unvote) transaction, which commits the stake into a \textit{thawing} state. This function returns an \textit{unvoteId}, which uniquely identifies this unvote operation. After the thawing period has elapsed (\S\ref{stake_concerns}), at any time, any user in the system can call the finalize function, to release the thawed coins back to the staker. 

\begin{figure}[ht]
\centering
\includegraphics{sequence-diagrams/private-staking.tikz}
\caption{Private staking in Aion-Unity}
\label{fig:priv_staking}
\end{figure}
\clearpage

\subsection{ADS Pool Setup}
Figure \ref{fig:pool_setup} describes the setup of a staking pool. First, the operator must sign up with the StakerRegistry (using a dummy coinbase address). Then he must sign up in the PoolRegistry with the appropriate setup arguments; this call returns the address of the freshly deployed the coinbase contract (\S\ref{sc_design}). The operator must take the return coinbase contract address and set it as his coinbase in the StakerRegistry. The operator must also register the PoolRegistry contract as the StakerRegistryListener in the StakerRegistry, at any point after registering himself as a staker in the StakerRegistry, to complete the setup. 

\begin{figure}[ht]
\centering
\includegraphics{sequence-diagrams/pool-setup.tikz}
\caption{ADS pool setup in Aion-Unity}
\label{fig:pool_setup}
\end{figure}
\clearpage

\subsection{Delegation to an ADS Pool}

Figure \ref{fig:delegation} illustrates the mechanism of delegation and undelegation of stake to an ADS pool. Note that the delegator only has to interact with the PoolRegistry contract to complete their delegation workflow. 

In order to delegate stake, a user must send their coins to the PoolRegistry in a delegate transaction. When delegate is invoked, the PoolRegistry records the delegation and adds the stake to the pool's balance in the StakerRegistry; to the staking registry, the pool looks like one big staker. 

The undelegation of stake is a two-step process (since unbonding of stake is involved). When a user calls the undelegate function in the PoolRegistry, an unvoteTo is triggered in the StakerRegistry, which returns the corresponding unvoteId, which uniquely identifies the thawing of this parcel of stake. After the thawing period has elapsed, any user can call the finalizeUnvote function, either through the PoolRegistry or directly in the StakerRegistry with the unvoteId of the delegator, to release the liquid coins back to their account. 

\begin{figure}[ht]
\centering
\includegraphics{sequence-diagrams/delegation.tikz}
\caption{ADS delegation and undelegation in Aion-Unity}
\label{fig:delegation}
\end{figure}
\clearpage

\subsection{Auto-Delegation of Rewards}

Figure \ref{fig:redelegation} demonstrates the  auto rewards delegation feature in ADS. A user can enable this feature either at the moment of a delegation, or after the fact as a separate transaction. Once enabled, this feature enables any user to call the auto-redelegate function to commit a delegator's earned rewards as stake. At any point, the delegator can disable this feature. 

\begin{figure}[ht]
\centering
\includegraphics{sequence-diagrams/auto-redelegate.tikz}
\caption{Auto redelegation of rewards in Aion Unity}
\label{fig:redelegation}
\end{figure}
\clearpage

\subsection{Stake Transfer}

Figure \ref{fig:delegation_transfer} demonstrates the stake transfer feature, at the level of the PoolRegistry (although this interaction looks almost identical for a solo-staker interacting directly with the StakerRegistry). 

A delegator must initiate a transfer of stake between stakers (pools) at PoolRegistry, which in-turn reflects the transfer in the StakerRegistry. A transferId is returned, which uniquely identifies this transfer. After the transfer lockout period has elapsed, any user can call finalize to move the stake between the source and destination stakers.

\begin{figure}[ht]
\centering
\includegraphics{sequence-diagrams/delegation-transfer.tikz}
\caption{Stake transfer feature in Aion-Unity}
\label{fig:delegation_transfer}
\end{figure}
\clearpage

\subsection{Delegator Withdrawal}

Figure \ref{fig:withdrawal} demonstrates a withdrawal of rewards earned by a delegator. Rewards are continually withdrawn from a pool's coinbase contract any time the stake apportionment in the pool changes (via a delegation, undelegation, etc.) and managed by the PoolRegistry (see \S\ref{f1-rewards} for details). A withdraw is yet another trigger for the pool's coinbase to be emptied of accumulated rewards (if any exist). Then, the F1 rewards sharing algorithm is invoked to compute the rewards owed to the delegator, which are promptly disbursed before winding down the transaction. 

\begin{figure}[ht]
\centering
\includegraphics{sequence-diagrams/withdrawal.tikz}
\caption{Delegation rewards withdrawal in Aion-Unity}
\label{fig:withdrawal}
\end{figure}
\clearpage